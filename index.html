<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>视频测试</title>
  <style>
    .container {
      font-size: 14px;
      position: absolute;
      z-index: 0;
      width: 100%;
      height: 100%;
      top: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .videoitem {
      margin-top: 41px;
      width: 297px;
      height: 167px;
      /* Add your styles for .page-video here */
    }

    .littlerex {
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      margin-left: 27.5px;
      margin-right: 27.5px;
      width: 122px;
      /* 宽度为122像素 */
      height: 128px;
      /* 高度为128像素 */
    }


    /* Add styles for other classes as needed */
  </style>
</head>

<body>
  <div class="container">
    <label style="margin-top: 100px;" for="numberInput">请输入延迟：</label>
    <input type="number" id="numberInput" value="0" oninput="handleInput()">
    <button style="margin-top: 10px;" onclick="showConsoleOutput()">显示console.log输出</button>
      <div id="consoleOutputDialog" style="display: none;">
          <h2>console.log输出：</h2>
          <pre id="consoleOutputContent"></pre>
          <button onclick="closeConsoleOutput()">关闭</button>
      </div>

    <video class="videoitem" preload="auto" style="margin-top: 20px;" poster="images/snowpic.png" id="video1" src="video1.mp4" controls></video>
    <span style="margin-top: 7px;">滑雪开场</span>
    <video class="videoitem" preload="auto" poster="images/fireworkpic.png" id="video2" src="video2.mp4" controls></video>
    <span style="margin-top: 7px;">终点礼花</span>
    <div style="margin-top: 47px; display: flex; flex-direction: row; justify-content: center;">
      <div style="width: 50vw; display: flex; flex-direction: column; align-items: center;">
        <div class="littlerex" style="background-color: #EAEAEA;">
          <img id="coin" src="images/coin.svg" alt="吃金币" style="width: 75px; height: 75px; z-index: 10;">
          <audio id="coinaudio" src="coin.wav" preload="auto"></audio>
        </div>
        <span style="margin-top: 7px;">吃金币</span>
      </div>
      <div style="width: 50vw; display: flex; flex-direction: column; align-items: center;">
        <div class="littlerex" style="background-color: #EAEAEA;">
          <img id="flag" src="images/flag.svg" alt="过旗门" style="width: 75px; height: 75px; z-index: 10;">
          <audio id="flagaudio" src="flag.wav" preload="auto"></audio>
        </div>
        <span style="margin-top: 7px;">过旗门</span>
      </div>
    </div>

  </div>
  <script type="text/javascript" src="jquery.js"></script>

  <script type="text/javascript">
    var data = {
      oncoin: false,
      onflag: false,

      touzidelay: -5,
      timer: null,
      delayflag: false,
      call: [false, false, false, false],
      isShow: [true, true],
      fullScreenFlag: [false, false],
      src_container: ['', ''],
      src: ['https://746f-touchdemo-0grtzfen1fa5e367-1317436880.tcb.qcloud.la/huaxue.mp4?sign=d55ad5c0907b19be598984f9d7f1fde9&t=1689664669', 'https://746f-touchdemo-0grtzfen1fa5e367-1317436880.tcb.qcloud.la/lihua.mp4?sign=63224e4585442a5b149043e547c4b5a0&t=1689746178'],
      music_src: ['https://746f-touchdemo-0grtzfen1fa5e367-1317436880.tcb.qcloud.la/coin.wav?sign=aaea5b47d6c6f4a3f67140b676541e9f&t=1689664629', 'https://746f-touchdemo-0grtzfen1fa5e367-1317436880.tcb.qcloud.la/flag.wav?sign=85b1f92a2b3f6f2e75de35c968334fcb&t=1689664641'],
      poster: ['cloud://touchdemo-0grtzfen1fa5e367.746f-touchdemo-0grtzfen1fa5e367-1317436880/snowpic.png', 'cloud://touchdemo-0grtzfen1fa5e367.746f-touchdemo-0grtzfen1fa5e367-1317436880/fireworkpic.png'],
      jsondata: ['ahap/video1.ahap', 'ahap/video2.ahap', 'ahap/coin.ahap', 'ahap/flag.ahap'],

      vider: '',
      w: 0,
      h: 0,
      progress: [100, 100],
      timePoint: [],
      flag: [],
      delay: 0,
      videoPlayIcon: '../../images/playbutton.svg',
      startlong: 26.265,
      endlong: 28.775,
      currentIndex: 0,
      playflag: false
    };


    let timelistdata = [];
    //以get请求方式加载所有触觉json文件 ['ahap/video1.ahap', 'ahap/video2.ahap', 'ahap/coin.ahap', 'ahap/flag.ahap']
    data.jsondata.forEach((element, index) => {
      var jsonData
      $(document).ready(function () {
        $.ajax({
          url: element,//json文件位置，文件名
          type: "GET",//请求方式为get
          dataType: "json", //返回数据格式为json
          async: false,
          success: function (jsondata) {
            let videoData = jsondata.Pattern;
            let timelist = [];
            let hapticlist = [0, 0];
            videoData.forEach(element => {
              if (element["Event"]) {
                if (element["Event"]["EventType"] == "HapticTransient") {
                  hapticlist[0] = element["Event"]["Time"];
                  hapticlist[1] = element["Event"]["EventParameters"][0]["ParameterValue"];
                  timelist.push([hapticlist[0], hapticlist[1]]);

                }
              }
            })
            timelistdata[index] = timelist;
            data.timePoint = timelistdata  //将触觉震动数据加载到data.timePoint中
          }
        }

        )




      })

    }
    );

    var imageElement1 = document.getElementById('coin');

    // 添加点击事件处理程序
    imageElement1.addEventListener('click', function () {
      // 在这里编写点击事件的处理逻辑
      var audioElement = document.getElementById('coinaudio');

      audioElement.addEventListener('canplay', function () { //为play函数添加监听器
        console.log("ready to play "+new Date().getTime());
        setTimeout(()=>{vibrate(-1, data.timePoint[2])},data.delay) //delay控制点击之后多久开始震动
      });

      audioElement.play();
    });



    var imageElement2 = document.getElementById('flag');

    // 添加点击事件处理程序
    imageElement2.addEventListener('click', function () {
      // 在这里编写点击事件的处理逻辑
      var audioElement = document.getElementById('flagaudio');

      audioElement.addEventListener('canplay', function () {
        setTimeout(()=>{vibrate(-1, data.timePoint[3])},data.delay)
      }); audioElement.play();
    });

    var video1 = document.getElementById('video1')
    video1.addEventListener('canplay', function (e) {
      data.playflag = true
      data.currentIndex = 0
    })
    video1.addEventListener('pause', function (e) {
      clearTimeout(data.timer)
      clearTimeout(data.timer_long)
    })
    video1.addEventListener('ended', function() {
      clearTimeout(data.timer)
      clearTimeout(data.timer_long)
            exitFullScreen();
        });
    video1.addEventListener('timeupdate', function (e) {
      var currentTime = video1.currentTime;
      console.log(currentTime)
      let delaytime = data.delay / 1000;
      console.log(new Date().getTime())
      console.log('time:' + currentTime);

      let interval = 0.5;
      let stren = 'heavy';
      let allay = [];
      allay.length = 0;

      data.timePoint[0].forEach((element, index) => {

        if (element[0] - currentTime + delaytime <= interval && element[0] - currentTime + delaytime > 0) {

          console.log('timepoint:' + element[0]);
          let longFlag = (element[0] > data.startlong - 0.01) && (element[0] < data.endlong + 0.01);
          allay.push([(element[0] + delaytime - currentTime), element[1], 0]);

        }/////
      });
      // if (data.currentIndex == 1) {
      //   if (0.766 - currentTime + delaytime <= interval && 0.766 - currentTime + delaytime > 0) {
      //     allay.push([(0.766 + delaytime - currentTime), 1, 1])
      //   }

      // }
      if (allay.length > 0) {
        clearTimeout(data.timer)
        clearTimeout(data.timer_long)
        vibrate(-1, allay)
      }

    })

    var video2 = document.getElementById('video2')
    video2.addEventListener('canplay', function (e) {
      data.playflag = true
      data.currentIndex = 1
    })
    video2.addEventListener('pause', function (e) {
      clearTimeout(data.timer)
      clearTimeout(data.timer_long)
    })
    video2.addEventListener('ended', function() {
      clearTimeout(data.timer)
      clearTimeout(data.timer_long)
            exitFullScreen();
        });
    video2.addEventListener('timeupdate', function (e) {
      var currentTime = video2.currentTime;
      console.log(currentTime)
      let delaytime = data.delay / 1000;
      console.log(new Date().getTime())
      console.log('time:' + currentTime);

      let interval = 0.5;
      let stren = 'heavy';
      let allay = [];
      allay.length = 0;

      data.timePoint[1].forEach((element, index) => {

        if (element[0] - currentTime + delaytime <= interval && element[0] - currentTime + delaytime > 0) {

          console.log('timepoint:' + element[0]);
          let longFlag = (element[0] > data.startlong - 0.01) && (element[0] < data.endlong + 0.01);
          allay.push([(element[0] + delaytime - currentTime), element[1], 0]);


        }/////
      });
      // if (data.currentIndex == 1) {
      //   if (0.766 - currentTime + delaytime <= interval && 0.766 - currentTime + delaytime > 0) {
      //     allay.push([(0.766 + delaytime - currentTime), 1, 1])
      //   }

      // }
      if (allay.length > 0) {
        clearTimeout(data.timer)
        clearTimeout(data.timer_long)
        vibrate(-1, allay)
      }

    })
    function handleInput(){
      const inputElement = document.getElementById('numberInput');
      const outputElement = document.getElementById('output');  
      // 获取用户输入的数字
      const inputValue = inputElement.value;
      data.delay=inputValue 
    }



    function showConsoleOutput() {
    // 保存原始的console.log函数
    var originalConsoleLog = console.log;

    // 重定向console.log到页面上的元素
    console.log = function(message) {
        var consoleOutputContent = document.getElementById("consoleOutputContent");
        consoleOutputContent.textContent += message + "\n";
    };

    // 显示console.log输出对话框
    var consoleOutputDialog = document.getElementById("consoleOutputDialog");
    consoleOutputDialog.style.display = "block";
}

function closeConsoleOutput() {
    // 隐藏console.log输出对话框
    var consoleOutputDialog = document.getElementById("consoleOutputDialog");
    consoleOutputDialog.style.display = "none";

    // 恢复原始的console.log函数
    console.log = originalConsoleLog;
}


    function vibrate(i, allay) {
      var delay = -2
      if (i == -1) { //当前是第一个震动
        var step = parseFloat(delay) + parseFloat(allay[i + 1][0]) * 1000; //allay中的时间以秒为单位，step以ms为单位
        if (step < 0) step = 1 //已经错过震动，等待1ms后处理下一个震动
      }
      else {
        var step = parseFloat(delay) + parseFloat(allay[i + 1][0] - allay[i][0]) * 1000;
        if (step < 0) step = 1
      }
      if (allay[i + 1][1] > 1) {
        console.log('wait' + step)
        data.timer = setTimeout(() => {
          clearTimeout(data.timer) 
          navigator.vibrate(allay[i + 1][1]);
          console.log(new Date().getTime())
          console.log('长震动'+allay[i + 1][1])
          if (i < allay.length - 2) vibrate(i + 1, allay)
        }, step)
      } else {
        let stren = 'heavy'
        if (allay[i + 1][1] < 0.3) stren = 'light';
        else if (allay[i + 1][1] < 0.6) stren = 'medium';
        else stren = 'heavy';
        console.log('wait' + step)
        data.timer = setTimeout(() => {
          clearTimeout(data.timer)
          navigator.vibrate(15);
          console.log(new Date().getTime())
          if (i < allay.length - 2) vibrate(i + 1, allay)
        }, step)
      }
    }
    function exitFullScreen() {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            }
        }

  </script>
</body>

</html>